<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
</head>
<body>
    <header>Test Video Download</header>
    <div id="log" style="color: #ff0000">
    </div>
    <script type="text/javascript">
    (function () {
      'use strict';
      // Uses node.js fs module to save files into sd card.
      var fs = require('fs');

      var writer = fs.createWriteStream('/storage/sd/video.mp4', {defaultEncoding:'binary'});

      // Replace this with your own url:
      const VIDEO_URL = 'http://brightsignbiz.s3.amazonaws.com/videos/Overview-video-series3-07012016.mp4';

      let soFar;
      let contentLength;

      // Uses fetch instead of XMLHttpRequest to support saving fragments into file as they
      // arrive. XMLHttpRequest will cause device to run out of memory when used with
      // large video files.
      fetch(VIDEO_URL).then(function (res) {
        soFar = 0;
        contentLength = res.headers.get('Content-Length');
        // Content length might not be known, that is normal.
        if (contentLength)
          console.log("Content length is " + contentLength);
        else
          console.log("Content length is not known");

        return pump(res.body.getReader());
      })
      .catch(function (e) {
        console.log(e);
      });

      function pump(reader) {
        return reader.read().then(function (result) {
          if (result.done) {
            console.log("All done! " + soFar + "bytes total");
            writer.end();
            return;
          }

          const chunk = result.value; // --> This is the chunked data
          writer.write(new Buffer(chunk));

          soFar += chunk.byteLength;
          // Console log takes long time, comment this out to download in full speed.
          updateProgress();
          return pump(reader);
        });
      }

      function updateProgress() {
        if (contentLength)
          console.log((soFar/contentLength*100).toFixed(2) + "% is downloaded");
        else
          console.log(soFar + " bytes are downloaded");
      }
    }());
    </script>
</body>
</html>
